# 后端项目技术底层方案文档

> 本文档整理了一个生产级 Node.js 后端项目的完整技术架构和最佳实践，可供其他 AI 或开发者参考使用，快速构建同级别的后端程序。

---

## 1. 技术栈概览

### 1.1 核心技术选型

| 类别 | 技术 | 版本要求 | 说明 |
|------|------|----------|------|
| 运行时 | Node.js | >=18.0.0 | LTS 版本，支持 ES2020+ |
| 语言 | TypeScript | ^5.3.3 | 强类型支持 |
| Web 框架 | Express | ^4.18.2 | 成熟稳定的 HTTP 框架 |
| 包管理器 | pnpm | >=10.0.0 | 高效的依赖管理 |
| 数据库 | MySQL | 8.0 | 关系型数据库 |
| ORM | Sequelize | ^6.35.2 | 数据库抽象层 |
| 缓存 | Redis (ioredis) | ^5.9.2 | 可选的缓存层 |
| 验证 | Joi | ^17.11.0 | 数据验证库 |
| 日志 | Winston | ^3.11.0 | 结构化日志 |
| 监控 | prom-client | ^15.1.3 | Prometheus 指标 |
| API 文档 | Swagger (swagger-jsdoc + swagger-ui-express) | ^6.2.8 / ^5.0.0 | OpenAPI 规范 |

### 1.2 开发依赖

| 类别 | 技术 | 说明 |
|------|------|------|
| 测试框架 | Jest | ^29.7.0 |
| 测试类型转换 | ts-jest | ^29.1.1 |
| HTTP 测试 | supertest | ^6.3.3 |
| 属性测试 | fast-check | ^3.15.0 |
| 代码检查 | ESLint + @typescript-eslint | 代码规范 |
| 类型定义 | @types/* | TypeScript 类型 |

---

## 2. 项目结构

```
project-root/
├── src/
│   ├── index.ts              # 应用入口，服务器启动
│   ├── app.ts                # Express 应用配置
│   ├── config/               # 配置模块
│   │   ├── database.ts       # 数据库连接配置
│   │   ├── env.ts            # 环境变量验证和加载
│   │   ├── logger.ts         # Winston 日志配置
│   │   ├── metrics.ts        # Prometheus 指标定义
│   │   ├── redis.ts          # Redis 缓存配置
│   │   └── swagger.ts        # Swagger/OpenAPI 配置
│   ├── middleware/           # Express 中间件
│   │   ├── index.ts          # 中间件导出
│   │   ├── ErrorMiddleware.ts        # 全局错误处理
│   │   ├── ValidationMiddleware.ts   # 请求验证
│   │   ├── LoggingMiddleware.ts      # 请求日志
│   │   ├── RateLimitMiddleware.ts    # API 限流
│   │   ├── RequestIdMiddleware.ts    # 请求 ID 追踪
│   │   └── MetricsMiddleware.ts      # 监控指标收集
│   ├── models/               # 数据模型 (Sequelize)
│   │   ├── index.ts          # 模型导出
│   │   ├── [Entity].ts       # 实体模型定义
│   │   └── migrations/       # 数据库迁移脚本
│   │       ├── xxx.sql       # SQL 迁移文件
│   │       └── migrate.ts    # 迁移执行器
│   ├── repositories/         # 数据访问层 (Repository Pattern)
│   │   ├── index.ts
│   │   └── [Entity]Repository.ts
│   ├── services/             # 业务逻辑层
│   │   ├── index.ts
│   │   └── [Entity]Service.ts
│   ├── routes/               # API 路由定义
│   │   ├── index.ts
│   │   └── [Entity]Routes.ts
│   ├── types/                # TypeScript 类型定义
│   │   ├── index.ts          # 业务类型
│   │   └── express.d.ts      # Express 类型扩展
│   └── validation/           # Joi 验证模式
│       ├── schemas.ts        # 验证模式定义
│       └── validator.ts      # 验证工具函数
├── docs/                     # 项目文档
├── logs/                     # 日志文件目录
├── dist/                     # 编译输出目录
├── coverage/                 # 测试覆盖率报告
├── package.json
├── pnpm-lock.yaml
├── tsconfig.json
├── jest.config.js
├── jest.setup.js
├── Dockerfile
├── docker-compose.yml
└── .env.example
```

---

## 3. TypeScript 配置

### 3.1 tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.test.ts", "**/*.integration.ts"]
}
```

### 3.2 严格模式要点

- `strict: true` - 启用所有严格类型检查
- `noUnusedLocals/Parameters` - 禁止未使用的变量
- `noImplicitReturns` - 确保所有代码路径都有返回值

---

## 4. 分层架构模式

### 4.1 三层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Routes (路由层)                           │
│  - 定义 API 端点                                             │
│  - 请求验证中间件                                            │
│  - 调用 Service                                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Services (业务逻辑层)                      │
│  - 业务规则处理                                              │
│  - 数据转换                                                  │
│  - 调用 Repository                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 Repositories (数据访问层)                    │
│  - 数据库 CRUD 操作                                          │
│  - 查询构建                                                  │
│  - 使用 Sequelize Model                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Models (数据模型层)                       │
│  - Sequelize 模型定义                                        │
│  - 字段验证                                                  │
│  - 数据库映射                                                │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 Service 层模板

```typescript
export class EntityService {
  constructor(private repository: EntityRepository = defaultRepository) {}

  async create(input: EntityInput): Promise<EntityOutput> {
    // 1. 验证输入
    const validatedData = validateOrThrow<EntityInput>(schema, input);
    
    // 2. 业务逻辑处理
    logger.info('Creating entity', { ... });
    
    // 3. 调用 Repository
    const entity = await this.repository.create(validatedData);
    
    // 4. 转换输出格式
    return this.toOutput(entity);
  }

  async getById(id: number): Promise<EntityOutput | null> {
    const entity = await this.repository.findById(id);
    return entity ? this.toOutput(entity) : null;
  }

  async query(filters: Filters, pagination: Pagination): Promise<PaginatedResult<EntityOutput>> {
    const [entities, total] = await Promise.all([
      this.repository.findByFilters(filters, pagination),
      this.repository.countByFilters(filters),
    ]);
    
    return {
      data: entities.map(e => this.toOutput(e)),
      pagination: { ...pagination, total, totalPages: Math.ceil(total / pagination.pageSize) },
    };
  }

  private toOutput(entity: Entity): EntityOutput {
    return { /* 字段映射 */ };
  }
}

// 导出单例
export const entityService = new EntityService();
```

### 4.3 Repository 层模板

```typescript
export class EntityRepository {
  async create(data: EntityCreationAttributes): Promise<Entity> {
    try {
      return await Entity.create(data);
    } catch (error) {
      throw new DatabaseError('Failed to create entity', 'DATABASE_ERROR', error);
    }
  }

  async findById(id: number): Promise<Entity | null> {
    try {
      return await Entity.findByPk(id);
    } catch (error) {
      throw new DatabaseError('Failed to find entity', 'DATABASE_ERROR', error);
    }
  }

  async findByFilters(filters: Filters, pagination: Pagination): Promise<Entity[]> {
    try {
      const whereClause = this.buildWhereClause(filters);
      const { page, pageSize } = pagination;
      
      return await Entity.findAll({
        where: whereClause,
        limit: pageSize,
        offset: (page - 1) * pageSize,
        order: [['createdAt', 'DESC']],
      });
    } catch (error) {
      throw new DatabaseError('Failed to query entities', 'DATABASE_ERROR', error);
    }
  }

  private buildWhereClause(filters: Filters): WhereOptions {
    const where: WhereOptions = {};
    // 构建查询条件
    if (filters.status) where.status = filters.status;
    if (filters.startTime && filters.endTime) {
      where.createdAt = { [Op.between]: [filters.startTime, filters.endTime] };
    }
    return where;
  }
}

export const entityRepository = new EntityRepository();
```

---

## 5. 中间件系统

### 5.1 中间件执行顺序

```typescript
export function createApp(): Application {
  const app = express();

  // 1. 信任代理（用于获取真实 IP）
  app.set('trust proxy', 1);

  // 2. 请求 ID 追踪（最先执行）
  app.use(requestIdMiddleware);

  // 3. 监控指标收集
  app.use(metricsMiddleware);

  // 4. 基础中间件
  app.use(cors());
  app.use(express.json());
  app.use(express.urlencoded({ extended: true }));

  // 5. 请求日志
  app.use(loggingMiddleware);

  // 6. API 文档
  app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec));

  // 7. 健康检查端点
  app.get('/health', healthCheckHandler);

  // 8. 监控指标端点
  app.get('/metrics', metricsHandler);

  // 9. API 限流
  app.use('/api', apiLimiter);

  // 10. API 路由
  app.use('/api/v1/entities', entityRoutes);

  // 11. 404 处理
  app.use(notFoundHandler);

  // 12. 全局错误处理（必须在最后）
  app.use(errorHandler);

  return app;
}
```

### 5.2 错误处理中间件

```typescript
// 自定义错误类型
export class ValidationError extends Error {
  constructor(
    message: string,
    public code: string = 'VALIDATION_ERROR',
    public details?: Record<string, unknown>
  ) {
    super(message);
    this.name = 'ValidationError';
  }
}

export class NotFoundError extends Error {
  constructor(message: string, public code: string = 'NOT_FOUND') {
    super(message);
    this.name = 'NotFoundError';
  }
}

export class DatabaseError extends Error {
  constructor(
    message: string,
    public code: string = 'DATABASE_ERROR',
    public originalError?: Error
  ) {
    super(message);
    this.name = 'DatabaseError';
  }
}

// 全局错误处理器
export function errorHandler(err: Error, req: Request, res: Response, _next: NextFunction): void {
  if (res.headersSent) {
    _next(err);
    return;
  }

  let statusCode = 500;
  let errorCode = 'INTERNAL_ERROR';
  let errorMessage = '服务器内部错误';
  let errorDetails: Record<string, unknown> | undefined;

  if (err instanceof ValidationError) {
    statusCode = 400;
    errorCode = err.code;
    errorMessage = err.message;
    errorDetails = err.details;
  } else if (err instanceof NotFoundError) {
    statusCode = 404;
    errorCode = err.code;
    errorMessage = err.message;
  } else if (err instanceof DatabaseError) {
    statusCode = 500;
    errorCode = err.code;
    errorMessage = '数据库操作失败';
  }

  // 记录错误
  logError('请求处理错误', err, { path: req.path, method: req.method, statusCode });

  // 返回标准化响应
  res.status(statusCode).json({
    error: {
      code: errorCode,
      message: errorMessage,
      ...(errorDetails && { details: errorDetails }),
    },
  });
}

// 异步路由包装器
export function asyncHandler(fn: (req: Request, res: Response, next: NextFunction) => Promise<any>) {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
}
```

### 5.3 验证中间件

```typescript
export function validateRequest(schema: Joi.Schema, type: 'body' | 'query' | 'params' = 'body') {
  return (req: Request, res: Response, next: NextFunction): void => {
    const result = schema.validate(req[type], {
      abortEarly: false,    // 收集所有错误
      stripUnknown: true,   // 移除未知字段
      convert: true,        // 自动类型转换
    });

    if (result.error) {
      const validationError = new ValidationError('请求数据验证失败', 'VALIDATION_ERROR', {
        errors: result.error.details.map(detail => ({
          field: detail.path.join('.'),
          message: detail.message,
          type: detail.type,
        })),
      });

      res.status(400).json({
        error: {
          code: validationError.code,
          message: validationError.message,
          details: validationError.details,
        },
      });
      return;
    }

    req[type] = result.value;
    next();
  };
}

// 便捷函数
export const validateBody = (schema: Joi.Schema) => validateRequest(schema, 'body');
export const validateQuery = (schema: Joi.Schema) => validateRequest(schema, 'query');
export const validateParams = (schema: Joi.Schema) => validateRequest(schema, 'params');
```

### 5.4 限流中间件

```typescript
import rateLimit from 'express-rate-limit';

// 通用 API 限流
export const apiLimiter = rateLimit({
  windowMs: 60 * 1000,  // 1 分钟
  max: 100,             // 每个 IP 最多 100 次请求
  standardHeaders: true,
  legacyHeaders: false,
  message: {
    error: {
      code: 'RATE_LIMIT_EXCEEDED',
      message: '请求过于频繁，请稍后再试',
    },
  },
  handler: (req, res, _next, options) => {
    logger.warn('Rate limit exceeded', { ip: req.ip, path: req.path });
    res.status(429).json(options.message);
  },
});

// 严格限流（写入操作）
export const strictLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 30,
  // ...
});
```

---

## 6. 配置管理

### 6.1 环境变量验证

```typescript
interface EnvConfig {
  nodeEnv: string;
  port: number;
  dbHost: string;
  dbPort: number;
  dbName: string;
  dbUser: string;
  dbPassword: string;
  dbPoolMin: number;
  dbPoolMax: number;
  logLevel: string;
  logFile: string;
  apiPrefix: string;
  maxPageSize: number;
  defaultPageSize: number;
}

function requireEnv(name: string): string {
  const value = process.env[name];
  if (!value) {
    throw new Error(`Required environment variable ${name} is not set`);
  }
  return value;
}

function getEnv(name: string, defaultValue: string): string {
  return process.env[name] || defaultValue;
}

function getEnvNumber(name: string, defaultValue: number): number {
  const value = process.env[name];
  if (!value) return defaultValue;
  const parsed = parseInt(value, 10);
  if (isNaN(parsed)) {
    throw new Error(`Environment variable ${name} must be a valid number`);
  }
  return parsed;
}

export const config: EnvConfig = {
  nodeEnv: getEnv('NODE_ENV', 'development'),
  port: getEnvNumber('PORT', 3000),
  dbHost: requireEnv('DB_HOST'),
  dbPort: getEnvNumber('DB_PORT', 3306),
  dbName: requireEnv('DB_NAME'),
  dbUser: requireEnv('DB_USER'),
  dbPassword: requireEnv('DB_PASSWORD'),
  dbPoolMin: getEnvNumber('DB_POOL_MIN', 2),
  dbPoolMax: getEnvNumber('DB_POOL_MAX', 10),
  logLevel: getEnv('LOG_LEVEL', 'info'),
  logFile: getEnv('LOG_FILE', 'logs/app.log'),
  apiPrefix: getEnv('API_PREFIX', '/api'),
  maxPageSize: getEnvNumber('MAX_PAGE_SIZE', 100),
  defaultPageSize: getEnvNumber('DEFAULT_PAGE_SIZE', 20),
};
```

### 6.2 数据库配置 (Sequelize)

```typescript
import { Sequelize } from 'sequelize';

export const sequelize = new Sequelize({
  host: config.dbHost,
  port: config.dbPort,
  database: config.dbName,
  username: config.dbUser,
  password: config.dbPassword,
  dialect: 'mysql',
  
  pool: {
    min: config.dbPoolMin,
    max: config.dbPoolMax,
    acquire: 30000,  // 获取连接超时
    idle: 10000,     // 空闲连接超时
  },
  
  logging: (sql: string, timing?: number) => {
    if (config.nodeEnv === 'development') {
      logger.debug('SQL Query', { sql, timing });
    }
  },
  
  define: {
    timestamps: false,  // 手动管理时间戳
  },
});

// 数据库连接重试
export async function connectWithRetry(maxRetries = 5, delay = 3000): Promise<void> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      await sequelize.authenticate();
      logger.info('数据库连接成功');
      return;
    } catch (error) {
      logger.warn(`数据库连接失败 (${attempt}/${maxRetries})`);
      if (attempt === maxRetries) throw error;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}
```

### 6.3 日志配置 (Winston)

```typescript
import winston from 'winston';
import path from 'path';

const customFormat = winston.format.combine(
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.errors({ stack: true }),
  winston.format.json()
);

const consoleFormat = winston.format.combine(
  winston.format.colorize(),
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.printf(({ timestamp, level, message, ...meta }) => {
    let metaStr = Object.keys(meta).length > 0 ? '\n' + JSON.stringify(meta, null, 2) : '';
    return `${timestamp} [${level}]: ${message}${metaStr}`;
  })
);

export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: customFormat,
  transports: [
    new winston.transports.File({
      filename: process.env.LOG_FILE || 'logs/app.log',
      maxsize: 10485760,  // 10MB
      maxFiles: 5,
      tailable: true,
    }),
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error',
      maxsize: 10485760,
      maxFiles: 5,
    }),
  ],
});

// 非生产环境添加控制台输出
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({ format: consoleFormat }));
}

// 日志辅助函数
export function logError(message: string, error: Error, context?: Record<string, unknown>): void {
  logger.error(message, {
    error: { message: error.message, stack: error.stack, name: error.name },
    ...context,
  });
}
```

---

## 7. 数据验证 (Joi)

### 7.1 验证模式定义

```typescript
import Joi from 'joi';

// 常用正则
const UUID_PATTERN = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;

// 实体输入验证
export const entityInputSchema = Joi.object({
  uuid: Joi.string()
    .pattern(UUID_PATTERN)
    .required()
    .messages({
      'string.pattern.base': 'uuid must be a valid UUID v4 format',
      'any.required': 'uuid is required',
    }),
  
  name: Joi.string()
    .min(1)
    .max(100)
    .required()
    .messages({
      'string.min': 'name must be at least 1 character',
      'string.max': 'name must not exceed 100 characters',
    }),
  
  type: Joi.string()
    .valid('type1', 'type2', 'type3')
    .required()
    .messages({
      'any.only': 'type must be one of: type1, type2, type3',
    }),
  
  data: Joi.object()
    .required()
    .messages({
      'object.base': 'data must be a valid JSON object',
    }),
}).options({ stripUnknown: true });

// 分页验证
export const paginationSchema = Joi.object({
  page: Joi.number().integer().min(1).default(1),
  pageSize: Joi.number().integer().min(1).max(100).default(20),
});

// 过滤条件验证
export const filtersSchema = Joi.object({
  uuid: Joi.string().pattern(UUID_PATTERN).optional(),
  type: Joi.string().valid('type1', 'type2', 'type3').optional(),
  startTime: Joi.date().iso().optional(),
  endTime: Joi.date().iso().optional(),
}).options({ stripUnknown: true });
```

### 7.2 验证工具函数

```typescript
export function validateOrThrow<T>(schema: Joi.Schema, data: unknown): T {
  const result = schema.validate(data, {
    abortEarly: false,
    stripUnknown: true,
    convert: true,
  });
  
  if (result.error) {
    throw new ValidationError('Validation failed', 'VALIDATION_ERROR', {
      errors: result.error.details.map(detail => ({
        field: detail.path.join('.'),
        message: detail.message,
        type: detail.type,
      })),
    });
  }
  
  return result.value as T;
}
```

---

## 8. 数据模型 (Sequelize)

### 8.1 模型定义模板

```typescript
import { DataTypes, Model, Optional } from 'sequelize';
import { sequelize } from '../config/database';

// 属性接口
export interface EntityAttributes {
  id: number;
  uuid: string;
  name: string;
  type: 'type1' | 'type2' | 'type3';
  data: object;
  createdAt: Date;
}

// 创建时可选属性
export interface EntityCreationAttributes 
  extends Optional<EntityAttributes, 'id' | 'createdAt'> {}

// 模型类
export class Entity extends Model<EntityAttributes, EntityCreationAttributes> 
  implements EntityAttributes {
  declare id: number;
  declare uuid: string;
  declare name: string;
  declare type: 'type1' | 'type2' | 'type3';
  declare data: object;
  declare createdAt: Date;
}

// 初始化模型
Entity.init(
  {
    id: {
      type: DataTypes.BIGINT,
      primaryKey: true,
      autoIncrement: true,
    },
    uuid: {
      type: DataTypes.STRING(36),
      allowNull: false,
      field: 'uuid',  // 数据库字段名映射
      validate: {
        notEmpty: { msg: 'UUID cannot be empty' },
      },
    },
    name: {
      type: DataTypes.STRING(100),
      allowNull: false,
    },
    type: {
      type: DataTypes.ENUM('type1', 'type2', 'type3'),
      allowNull: false,
      field: 'type',
    },
    data: {
      type: DataTypes.JSON,
      allowNull: false,
    },
    createdAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: DataTypes.NOW,
      field: 'created_at',
    },
  },
  {
    sequelize,
    tableName: 'entities',
    timestamps: false,
    underscored: true,  // 使用 snake_case
    indexes: [
      { fields: ['uuid'] },
      { fields: ['type'] },
      { fields: ['created_at'] },
      { fields: ['uuid', 'type'] },  // 复合索引
    ],
  }
);
```

### 8.2 数据库迁移

```sql
-- Migration: Create entities table
CREATE TABLE IF NOT EXISTS entities (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  uuid VARCHAR(36) NOT NULL,
  name VARCHAR(100) NOT NULL,
  type ENUM('type1', 'type2', 'type3') NOT NULL,
  data JSON NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_uuid (uuid),
  INDEX idx_type (type),
  INDEX idx_created_at (created_at),
  INDEX idx_uuid_type (uuid, type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 9. API 文档 (Swagger)

### 9.1 Swagger 配置

```typescript
import swaggerJsdoc from 'swagger-jsdoc';

const options: swaggerJsdoc.Options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: '项目名称 API',
      version: '1.0.0',
      description: 'API 描述',
    },
    servers: [
      { url: '/api/v1', description: 'API v1' },
    ],
    components: {
      schemas: {
        Entity: {
          type: 'object',
          properties: {
            id: { type: 'integer' },
            uuid: { type: 'string', format: 'uuid' },
            name: { type: 'string' },
            type: { type: 'string', enum: ['type1', 'type2', 'type3'] },
            data: { type: 'object' },
            createdAt: { type: 'string', format: 'date-time' },
          },
        },
        Error: {
          type: 'object',
          properties: {
            error: {
              type: 'object',
              properties: {
                code: { type: 'string' },
                message: { type: 'string' },
                details: { type: 'object' },
              },
            },
          },
        },
        PaginatedResult: {
          type: 'object',
          properties: {
            data: { type: 'array', items: { $ref: '#/components/schemas/Entity' } },
            pagination: {
              type: 'object',
              properties: {
                page: { type: 'integer' },
                pageSize: { type: 'integer' },
                total: { type: 'integer' },
                totalPages: { type: 'integer' },
              },
            },
          },
        },
      },
    },
  },
  apis: ['./src/routes/*.ts'],
};

export const swaggerSpec = swaggerJsdoc(options);
```

---

## 10. 监控指标 (Prometheus)

```typescript
import client from 'prom-client';

export const register = new client.Registry();
client.collectDefaultMetrics({ register });

// HTTP 请求计数
export const httpRequestsTotal = new client.Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'path', 'status'],
  registers: [register],
});

// HTTP 请求延迟
export const httpRequestDuration = new client.Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP request duration in seconds',
  labelNames: ['method', 'path', 'status'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],
  registers: [register],
});

// 数据库连接池状态
export const dbPoolConnections = new client.Gauge({
  name: 'db_pool_connections',
  help: 'Database connection pool status',
  labelNames: ['state'],
  registers: [register],
});

// 错误计数
export const errorsTotal = new client.Counter({
  name: 'errors_total',
  help: 'Total number of errors',
  labelNames: ['type', 'code'],
  registers: [register],
});

// 缓存命中率
export const cacheHits = new client.Counter({
  name: 'cache_hits_total',
  help: 'Total cache hits',
  registers: [register],
});
```

---

## 11. 测试架构

### 11.1 Jest 配置

```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src'],
  testMatch: ['**/*.test.ts', '**/*.integration.ts', '**/*.property.test.ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.test.ts',
    '!src/**/*.integration.ts',
    '!src/**/*.property.test.ts',
    '!src/types/**',
    '!src/**/index.ts',
    '!src/index.ts',
    '!src/routes/**',
    '!src/models/migrations/**',
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  coverageThreshold: {
    global: {
      statements: 75,
      branches: 60,
      functions: 65,
      lines: 75,
    },
  },
  moduleFileExtensions: ['ts', 'js', 'json'],
  verbose: true,
  testTimeout: 10000,
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
};
```

### 11.2 测试文件命名规范

- `*.test.ts` - 单元测试
- `*.integration.ts` - 集成测试
- `*.property.test.ts` - 属性测试

### 11.3 单元测试模板

```typescript
import { EntityService } from './EntityService';
import { EntityRepository } from '../repositories/EntityRepository';

jest.mock('../repositories/EntityRepository');
jest.mock('../config/logger');

describe('EntityService', () => {
  let service: EntityService;
  let mockRepository: jest.Mocked<EntityRepository>;

  beforeEach(() => {
    mockRepository = {
      create: jest.fn(),
      findById: jest.fn(),
      findByFilters: jest.fn(),
      countByFilters: jest.fn(),
    } as any;

    service = new EntityService(mockRepository);
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('create', () => {
    it('should create entity with valid input', async () => {
      const input = { uuid: '...', name: 'test', type: 'type1', data: {} };
      const mockEntity = { id: 1, ...input, createdAt: new Date() };
      
      mockRepository.create.mockResolvedValue(mockEntity as any);
      
      const result = await service.create(input);
      
      expect(result.id).toBe(1);
      expect(mockRepository.create).toHaveBeenCalledWith(expect.objectContaining(input));
    });

    it('should reject invalid input', async () => {
      const invalidInput = { name: 'test' } as any;
      
      await expect(service.create(invalidInput)).rejects.toThrow(ValidationError);
    });
  });
});
```

### 11.4 属性测试模板 (fast-check)

```typescript
import fc from 'fast-check';
import { EntityService } from './EntityService';

describe('EntityService - Property Tests', () => {
  let service: EntityService;
  let mockRepository: jest.Mocked<EntityRepository>;

  // 定义任意值生成器
  const uuidArbitrary = fc.uuid().filter(uuid => 
    /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(uuid)
  );
  
  const typeArbitrary = fc.constantFrom('type1' as const, 'type2' as const, 'type3' as const);
  
  const entityInputArbitrary = fc.record({
    uuid: uuidArbitrary,
    name: fc.string({ minLength: 1, maxLength: 100 }),
    type: typeArbitrary,
    data: fc.dictionary(fc.string(), fc.oneof(fc.string(), fc.integer(), fc.boolean())),
  });

  beforeEach(() => {
    // ... 设置 mock
  });

  describe('Round-trip consistency', () => {
    it('should preserve data when creating and retrieving', async () => {
      await fc.assert(
        fc.asyncProperty(entityInputArbitrary, async (input) => {
          // 设置 mock
          mockRepository.create.mockResolvedValue({ id: 1, ...input, createdAt: new Date() } as any);
          mockRepository.findById.mockResolvedValue({ id: 1, ...input, createdAt: new Date() } as any);

          const created = await service.create(input);
          const retrieved = await service.getById(created.id);

          expect(retrieved!.uuid).toBe(input.uuid);
          expect(retrieved!.type).toBe(input.type);
        }),
        { numRuns: 100 }
      );
    });
  });
});
```

---

## 12. Docker 配置

### 12.1 多阶段 Dockerfile

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder

RUN corepack enable && corepack prepare pnpm@10 --activate

WORKDIR /app

COPY package.json pnpm-lock.yaml ./
COPY tsconfig.json ./

RUN pnpm install --frozen-lockfile

COPY src ./src

RUN pnpm run build

# 生产阶段
FROM node:18-alpine

RUN corepack enable && corepack prepare pnpm@10 --activate

WORKDIR /app

COPY package.json pnpm-lock.yaml ./

RUN pnpm install --prod --frozen-lockfile

COPY --from=builder /app/dist ./dist
COPY src/models/migrations ./dist/models/migrations

RUN mkdir -p logs

# 创建非 root 用户
RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001
RUN chown -R nodejs:nodejs /app
USER nodejs

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["node", "dist/index.js"]
```

### 12.2 docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app-service
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=${DB_NAME:-app_db}
      - DB_USER=${DB_USER:-root}
      - DB_PASSWORD=${DB_PASSWORD:-password}
      - DB_POOL_MIN=${DB_POOL_MIN:-2}
      - DB_POOL_MAX=${DB_POOL_MAX:-10}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  mysql:
    image: mysql:8.0
    container_name: app-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD:-password}
      - MYSQL_DATABASE=${DB_NAME:-app_db}
      - MYSQL_CHARACTER_SET_SERVER=utf8mb4
      - MYSQL_COLLATION_SERVER=utf8mb4_unicode_ci
    ports:
      - "${DB_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./src/models/migrations:/docker-entrypoint-initdb.d
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD:-password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  app-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
```

---

## 13. NPM Scripts

```json
{
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js",
    "dev": "ts-node src/index.ts",
    "test": "jest",
    "test:unit": "jest --testPathPattern=\\.test\\.ts$",
    "test:integration": "jest --testPathPattern=\\.integration\\.ts$",
    "test:coverage": "jest --coverage",
    "lint": "eslint src --ext .ts",
    "migrate": "ts-node src/models/migrations/migrate.ts up",
    "migrate:down": "ts-node src/models/migrations/migrate.ts down"
  }
}
```

---

## 14. 健康检查端点

```typescript
app.get('/health', async (_req, res) => {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    version: process.env.npm_package_version || '1.0.0',
    checks: {
      database: { status: 'unknown' },
      redis: { status: 'unknown', enabled: process.env.REDIS_ENABLED === 'true' },
    },
    memory: {
      used: process.memoryUsage().heapUsed,
      total: process.memoryUsage().heapTotal,
    },
  };

  try {
    const dbStart = Date.now();
    await sequelize.authenticate();
    health.checks.database = { status: 'healthy', latency: Date.now() - dbStart };
  } catch {
    health.status = 'degraded';
    health.checks.database = { status: 'unhealthy' };
  }

  const statusCode = health.status === 'ok' ? 200 : 503;
  res.status(statusCode).json(health);
});
```

---

## 15. 优雅关闭

```typescript
export function setupGracefulShutdown(server: http.Server): void {
  const shutdown = async (signal: string) => {
    logger.info(`收到 ${signal} 信号，开始优雅关闭...`);

    server.close(async () => {
      logger.info('HTTP 服务器已关闭');

      try {
        await sequelize.close();
        logger.info('数据库连接已关闭');
      } catch (error) {
        logger.error('关闭数据库连接时出错', { error });
      }

      try {
        await closeRedis();
        logger.info('Redis 连接已关闭');
      } catch (error) {
        logger.error('关闭 Redis 连接时出错', { error });
      }

      logger.info('优雅关闭完成');
      process.exit(0);
    });

    // 超时强制退出
    setTimeout(() => {
      logger.error('优雅关闭超时，强制退出');
      process.exit(1);
    }, 30000);
  };

  process.on('SIGTERM', () => shutdown('SIGTERM'));
  process.on('SIGINT', () => shutdown('SIGINT'));
}
```

---

## 16. 最佳实践总结

### 16.1 代码组织
- ✅ 使用三层架构：Routes → Services → Repositories
- ✅ 每层职责单一，便于测试和维护
- ✅ 使用依赖注入，便于 Mock 测试

### 16.2 错误处理
- ✅ 自定义错误类型 (ValidationError, NotFoundError, DatabaseError)
- ✅ 全局错误处理中间件
- ✅ 统一的错误响应格式

### 16.3 数据验证
- ✅ 使用 Joi 进行请求验证
- ✅ 中间件层验证，Service 层再次验证
- ✅ 详细的错误消息

### 16.4 日志记录
- ✅ 结构化 JSON 日志
- ✅ 请求 ID 追踪
- ✅ 分级别日志文件

### 16.5 监控
- ✅ Prometheus 指标
- ✅ 健康检查端点
- ✅ 性能指标收集

### 16.6 安全性
- ✅ API 限流
- ✅ CORS 配置
- ✅ 非 root 用户运行容器
- ✅ 环境变量管理敏感信息

### 16.7 测试
- ✅ 单元测试 + 属性测试
- ✅ Mock 依赖
- ✅ 覆盖率阈值

### 16.8 容器化
- ✅ 多阶段构建
- ✅ 健康检查
- ✅ 优雅关闭

---

## 17. 快速开始模板

要基于此方案创建新项目，请按以下步骤操作：

1. **初始化项目**
   ```bash
   mkdir my-project && cd my-project
   pnpm init
   ```

2. **安装依赖**
   ```bash
   # 生产依赖
   pnpm add express cors dotenv joi mysql2 sequelize winston prom-client swagger-jsdoc swagger-ui-express uuid ioredis express-rate-limit
   
   # 开发依赖
   pnpm add -D typescript @types/node @types/express @types/cors @types/uuid jest ts-jest @types/jest supertest @types/supertest fast-check eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin ts-node
   ```

3. **创建目录结构**
   ```bash
   mkdir -p src/{config,middleware,models/migrations,repositories,services,routes,types,validation} docs logs
   ```

4. **复制配置文件**
   - 复制 `tsconfig.json`
   - 复制 `jest.config.js`
   - 复制 `Dockerfile`
   - 复制 `docker-compose.yml`

5. **创建基础文件**
   - 按照本文档模板创建各层代码

6. **启动开发**
   ```bash
   pnpm dev
   ```

---

*文档版本: 1.0.0*  
*生成日期: 2026年1月23日*
